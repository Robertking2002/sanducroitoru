<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sandu Croitoru's Sanctuary</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root {
    --bg-color: #0b1021; 
    --text-color: #2c2c2c;
    --text-light: #fdfdfd;
    --accent-color: #8e7f66;
    --border-color: #e1e8ed;
}

* { box-sizing: border-box; }

body, html {
    margin: 0;
    padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    scroll-behavior: smooth;
    min-height: 100vh;
    overflow-x: hidden;
}

h1, h2, .nav-btn, .user-label, .section-header {
    font-family: 'Playfair Display', serif;
}

/* --- LOGO --- */
.logo-link {
    position: fixed;
    top: 15px;
    left: 25px;
    z-index: 1100;
    transition: all 0.3s ease;
}
.logo-link:hover { opacity: 0.7; }
.logo-img { height: 50px; }

/* --- HEADER --- */
header {
    position: fixed;
    top: 0;
    width: 100%;
    background: rgba(11, 16, 33, 0.85); 
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1000;
    display: flex;
    justify-content: center;
    padding: 20px 0;
    transition: all 0.3s ease;
}

nav { display: flex; align-items: center; flex-wrap: wrap; justify-content: center; }

nav button {
    background: none;
    border: none;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin: 0 15px;
    cursor: pointer;
    color: var(--text-light); 
    padding: 5px 10px;
    transition: color 0.3s;
}

nav button:hover { color: var(--accent-color); }
nav button.active {
    color: var(--accent-color);
    border-bottom: 2px solid var(--accent-color);
}

.lang-btn { background: none; border: none; cursor: pointer; padding: 5px; margin-left: 10px; }
.flag-icon { width: 30px; height: 20px; object-fit: cover; border-radius: 2px; }

/* --- HERO SECTION --- */
.hero-section {
    height: 65vh;
    transition: background-image 1.2s ease-in-out;
    background-size: cover;
    background-position: center; 
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-align: center;
    position: relative;
    padding: 0 20px;
}

.hero-section h1 {
    font-size: clamp(2rem, 8vw, 3.5rem); 
    text-shadow: 2px 2px 15px rgba(0,0,0,0.9);
    margin: 0;
}

/* --- MOBILE SPECIFIC --- */
@media (max-width: 768px) {
    .logo-link {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
    }

    header { padding-top: 70px; }

    nav button {
        margin: 5px;
        font-size: 0.75rem;
        letter-spacing: 1px;
    }

    @keyframes mobilePan {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .hero-section {
        background-size: auto 100%;
        animation: mobilePan 30s linear infinite;
    }
}

/* --- CONTENT CONTAINERS --- */
.book-item { display: flex; flex-direction: column; align-items: center; width: 100%; }

.book-desc-container {
    max-width: 750px; 
    margin: 30px auto; 
    text-align: justify; 
    line-height: 1.8; 
    font-size: 1.05rem;
    padding: 30px;
    color: #f0f0f0; 
    background: rgba(0, 0, 0, 0.6); 
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.main-content { padding-top: 100px; }
.tab-content { display: none; min-height: calc(100vh - 80px); animation: fadeIn 0.6s ease; }
.tab-content.active { display: block; }

/* --- POST CONTAINER --- */
.post-container {
    width: 90%;
    max-width: 900px;
    margin: -50px auto 50px;
    background: white;
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    position: relative;
    z-index: 10;
}

/* Admin editor is hidden by default */
#admin-editor-zone { 
    display: none; 
    margin-bottom: 40px; 
    border-bottom: 2px solid #f0f0f0; 
    padding-bottom: 20px; 
}

textarea#postInput { 
    width: 100%; 
    height: 120px; 
    border: 1px solid #eee; 
    font-size: 1.2rem; 
    padding: 15px; 
    border-radius: 8px; 
    outline: none; 
    font-family: inherit; 
}

.feed-item { 
    border-bottom: 1px solid #f0f0f0; 
    padding: 25px 0; 
    position: relative;
}

.user-label { 
    font-weight: 700; 
    font-size: 1.2rem; 
    color: var(--text-color); 
}

.timestamp { 
    color: #888; 
    font-size: 0.8rem; 
    display: block; 
    margin-bottom: 10px; 
}

/* Admin buttons styling */
.admin-buttons {
    margin-top: 15px;
    display: none;
}

.admin-buttons button {
    margin-right: 10px;
    padding: 5px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
}

.delete-btn {
    background-color: #ff4444;
    color: white;
}

.edit-btn {
    background-color: #4CAF50;
    color: white;
}

/* BOOKS - Starry Background */
#book1, #book2 {
    background-image: url('Stars.jpg');
    background-attachment: fixed;
    background-size: cover;
    background-position: center;
}

.book-wrapper {
    padding: 100px 20px 80px;
    display: flex; gap: 40px; justify-content: center; flex-wrap: wrap; text-align: center;
    color: white;
}

.book-img {
    width: 280px; height: 420px; object-fit: cover; border-radius: 8px; 
    cursor: pointer; box-shadow: 0 15px 35px rgba(0,0,0,0.6);
    transition: transform 0.4s ease;
}

.book-img:hover { transform: scale(1.02); }

.download-btn {
    margin-top: 30px; padding: 15px 40px; background: var(--accent-color);
    color: white; text-decoration: none; font-weight: bold; border-radius: 4px; display: inline-block;
}

.site-footer { 
    background: #000000; 
    color: white; 
    padding: 60px 20px; 
    text-align: center; 
    position: relative;
}

/* GHOST LOGIN AREA */
.ghost-login-area { 
    position: absolute;
    bottom: 10px;
    right: 10px;
    width: 20px; 
    height: 20px; 
    background: transparent; 
    z-index: 2000; 
    cursor: pointer;
}

.login-overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,0.85); 
    display: none; 
    align-items: center; 
    justify-content: center; 
    z-index: 99999; 
}

.login-box { 
    background: white; 
    padding: 40px; 
    border-radius: 16px; 
    text-align: center; 
    width: 90%; 
    max-width: 350px; 
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.translate-toggle { 
    background: none; 
    border: none; 
    font-size: 0.85rem; 
    font-weight: 600; 
    cursor: pointer; 
    color: var(--accent-color); 
    margin-top: 10px; 
    padding: 5px 0;
}

.translated-content { 
    margin-top: 10px; 
    padding: 15px; 
    background: #f9f9f9; 
    border-left: 3px solid var(--accent-color); 
    font-style: italic; 
    display: none;
    border-radius: 0 8px 8px 0;
}

.post-content {
    margin-top: 10px;
    line-height: 1.6;
    font-size: 1.05rem;
}

/* Loading spinner */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--accent-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Warning message */
.api-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
    font-size: 0.9rem;
}

/* Translation cache indicator */
.cache-indicator {
    font-size: 0.75rem;
    color: #28a745;
    margin-top: 5px;
}
</style>
</head>

<body>

<a class="logo-link" href="https://robertking2002.github.io/sanducroitoru/" target="_blank">
    <img src="Logo.png" class="logo-img" alt="Logo">
</a>

<div id="login-modal" class="login-overlay">
    <div class="login-box">
        <h2 id="login-title">Admin Access</h2>
        <input type="text" id="login-username" placeholder="Username" style="width:100%; padding:10px; margin-bottom:10px;">
        <input type="password" id="login-password" placeholder="Password" style="width:100%; padding:10px; margin-bottom:10px;">
        <div style="display:flex; gap:10px;">
            <button onclick="attemptLogin()" style="flex:1; padding:10px; background:var(--accent-color); color:white; border:none;">Login</button>
            <button onclick="closeLogin()" style="flex:1; padding:10px; background:#eee; border:none;">Cancel</button>
        </div>
    </div>
</div>

<header id="site-header">
    <nav>
        <button class="nav-btn active" onclick="showTab('home',this)" id="nav-home">Home</button>
        <button class="nav-btn" onclick="showTab('book1',this)" id="nav-book1">Faith Diagnosis - RO</button>
        <button class="nav-btn" onclick="showTab('book2',this)" id="nav-book2">Faith Diagnosis - GR</button>
        <button class="lang-btn" onclick="cycleLanguage()">
            <img src="https://flagcdn.com/w40/gb.png" id="flag-icon" class="flag-icon">
        </button>
    </nav>
</header>

<div class="main-content">
    <div id="home" class="tab-content active">
        <div class="hero-section" id="hero-slideshow">
            <h1 id="hero-title">Sandu Croitoru's Sanctuary</h1>
        </div>
        
        <div class="post-container">
            <div id="admin-editor-zone">
                <span class="user-label">Sandu Croitoru</span>
                <textarea id="postInput" placeholder="Share your thoughts..."></textarea>
                <div style="text-align:right; margin-top:10px;">
                    <button onclick="submitPost()" id="post-button" style="padding:10px 30px; background:var(--accent-color); color:white; border:none; border-radius:20px; cursor:pointer;">Post</button>
                    <span id="post-status" style="margin-left: 10px; font-size: 0.9rem; color: #666;"></span>
                </div>
            </div>
            
            <h2 id="latest-updates">Author's Thoughts</h2>
            <div id="feed"></div>
        </div>
        
        <footer class="site-footer">
            <p>© 2026 Sandu Croitoru. All rights reserved.</p>
            <div class="ghost-login-area" onclick="handleGhostClick()"></div>
        </footer>
    </div>

    <div id="book1" class="tab-content">
        <div class="book-wrapper">
            <div class="book-item">
                <img src="Cover1.jpg" id="img-b1" class="book-img" onclick="toggleCover('img-b1', 'Cover1.jpg', 'Cover3.jpg')">
                <h2 id="book1-title" style="margin-top: 30px; margin-bottom: 10px;">Diagnosis of Faith - RO</h2>
                <div class="book-desc-container">
                    <p id="book1-desc-p1">Faith is the algorithm of those who cannot perceive and deepen the truth through knowing and living it, and sums up only the aprioric uncertainty of the credal illusion of what the truth symbolizes or embodies. It is one thing for Jesus to become an accepted truth for you through your faith in Him and another to merge with the truth of Jesus from the perspective of the transhumance of the merging of one's own being through knowing Him. It is one thing to believe in the truth and another to transcend the truth by becoming an integral part of it through the Christ equation of the spiritual quantum metamorphosis of the being in the vibration of the phrase: "I am the truth!"</p>
                    <p id="book1-desc-p2">You cannot live, feel or know God through faith. Faith is the prerogative of ignorance. Praying to the one you do not know... the truth is not revealed to you through faith in Him but through knowing Him, and you continue to pray to the one you do not know. Do not expect the revelation of the truth through faith, at most the discovery of your own self, and that only if the faith you have, you have for yourself. Accepting a group faith transforms you into a spiritual semi-learned person; refusing group faith and aligning yourself with your own faith transforms you gradually into a learned person of semi-acquired truths. You were told that if you have faith as small as a mustard seed you will move mountains. Well you have it, so how many mountains have you moved with it? I do not ask you to move mountains, but put that mustard seed in front of you and through the faith you have: Move it! If it hasn't moved then you have a major problem with your own faith. The solution? Fulfillment. Jesus came to fulfill the Law, you fulfill your faith through knowledge, otherwise the Kingdom of Heaven will remain an unknown and untouched nimbus both literally and figuratively.</p>
                </div>
                <a href="Diagnoza_Credintei.pdf" target="_blank" class="download-btn" id="book1-btn">VIEW BOOK</a>
            </div>
        </div>
        <footer class="site-footer"><h2>Communication</h2><p>sandusilvia.croitoru@gmail.com</p></footer>
    </div>

    <div id="book2" class="tab-content">
        <div class="book-wrapper">
            <div class="book-item">
                <img src="Cover2.jpg" id="img-b2" class="book-img" onclick="toggleCover('img-b2', 'Cover2.jpg', 'Cover4.jpg')">
                <h2 id="book2-title" style="margin-top: 30px; margin-bottom: 10px;">Faith Diagnosis - GR</h2>
                <div class="book-desc-container">
                    <p id="book2-desc-p1">Coming Soon!</p>
                </div>
                <a href="#" target="_blank" class="download-btn" id="book2-btn" style="display:none;">BOOK</a>
            </div>
        </div>
        <footer class="site-footer"><h2>Communication</h2><p>sandusilvia.croitoru@gmail.com</p></footer>
    </div>
</div>

<script type="module">
// 1. Import the Firebase functions we need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

// 2. Your specific keys from the screenshot
const firebaseConfig = {
  apiKey: "AIzaSyBCwpfHmLZjDV5l2W-TKnN57K2ZqP5jg0c",
  authDomain: "sandu-croitoru.firebaseapp.com",
  projectId: "sandu-croitoru",
  storageBucket: "sandu-croitoru.firebasestorage.app",
  messagingSenderId: "998140149044",
  appId: "1:998140149044:web:8b1665b17fd320d44df961",
  measurementId: "G-VKQ3JVG7V2"
};

// 3. Initialize Firebase & Firestore
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 4. DEEPL API CONFIGURATION - USE YOUR KEY WITH :fx
const DEEPL_API_KEY = '178ff1aa-27be-4df3-a8a4-50243893aab1:fx'; // ← YOUR KEY HERE
const DEEPL_API_URL = 'https://api-free.deepl.com/v2/translate';

// --- GLOBAL VARIABLES ---
let currentLang = 'en';
const langOrder = ['en', 'gr', 'ro'];
let adminMode = false;
let editingPostId = null;

// --- TRANSLATIONS ---
const translations = {
    en: { 
        "nav-home": "Home", 
        "nav-book1": "Faith Diagnosis - RO", 
        "nav-book2": "Faith Diagnosis - GR", 
        "hero-title": "Sandu Croitoru's Sanctuary", 
        "latest-updates": "Author's Thoughts", 
        "post-button": "Post", 
        "footer-title": "Communication", 
        "book1-title": "Faith Diagnosis - RO", 
        "book2-title": "Faith Diagnosis - GR", 
        "book1-btn": "VIEW BOOK",
        "book2-btn": "BOOK", 
        "translate-to": "Translate to English", 
        "flag": "gb"
    },
    ro: { 
        "nav-home": "Acasă", 
        "nav-book1": "Diagnoza Credinței - RO", 
        "nav-book2": "Diagnoza Credinței - GR", 
        "hero-title": "Sanctuarul lui Croitoru Sandu", 
        "latest-updates": "Gândurile autorului", 
        "post-button": "Postează", 
        "footer-title": "Comunicare", 
        "book1-title": "Diagnoza Credinței - RO", 
        "book2-title": "Diagnoza Credinței - GR", 
        "book1-btn": "VEZI CARTEA",
        "book2-btn": "CARTE", 
        "translate-to": "Original", 
        "flag": "ro"
    },
    gr: { 
        "nav-home": "Αρχική", 
        "nav-book1": "Διάγνωση Πίστης - RO", 
        "nav-book2": "Διάγνωση Πίστης - GR", 
        "hero-title": "Το Λιμάνι του Croitoru Sandu", 
        "latest-updates": "Σκέψεις του συγγραφέα", 
        "post-button": "Ανάρτηση", 
        "footer-title": "Επικοινωνία", 
        "book1-title": "Διάγνωση Πίστης - RO", 
        "book2-title": "Διάγνωση Πίστης - GR", 
        "book1-btn": "ΠΡΟΒΟΛΗ ΒΙΒΛΙΟΥ",
        "book2-btn": "ΒΙΒΛΙΟ", 
        "translate-to": "Μετάφραση στα Ελληνικά", 
        "flag": "gr"
    }
};

// --- SLIDESHOW LOGIC ---
const slides = ['Background1.jpg', 'Background2.jpg', 'Background3.jpg'];
let slideIdx = 0;

function startSlideshow() {
    const hero = document.getElementById('hero-slideshow');
    hero.style.backgroundImage = `url('${slides[0]}')`;
    setInterval(() => {
        slideIdx = (slideIdx + 1) % slides.length;
        hero.style.backgroundImage = `url('${slides[slideIdx]}')`;
    }, 5000);
}

function toggleCover(id, front, back) {
    const img = document.getElementById(id);
    img.src = img.src.includes(front) ? back : front;
}

// --- TAB LOGIC ---
function showTab(tabId, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
    window.scrollTo(0,0);
}

// --- LANGUAGE LOGIC ---
function cycleLanguage() {
    let idx = (langOrder.indexOf(currentLang) + 1) % langOrder.length;
    currentLang = langOrder[idx];
    applyLang(currentLang);
}

function applyLang(lang) {
    const t = translations[lang];
    document.getElementById('flag-icon').src = `https://flagcdn.com/w40/${t.flag}.png`;
    for (let key in t) {
        const el = document.getElementById(key);
        if (el) el.textContent = t[key];
    }
    renderFeed();
}

// --- TRANSLATION CACHE SYSTEM ---
const translationCache = {
    get: function(text, targetLang) {
        const key = `${text}_${targetLang}`;
        const cached = localStorage.getItem(`translation_${key}`);
        return cached ? JSON.parse(cached) : null;
    },
    
    set: function(text, targetLang, translation) {
        const key = `${text}_${targetLang}`;
        localStorage.setItem(`translation_${key}`, JSON.stringify({
            translation: translation,
            timestamp: Date.now()
        }));
    },
    
    clearOld: function() {
        // Optional: Clear translations older than 30 days
        const oneMonthAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('translation_')) {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data.timestamp < oneMonthAgo) {
                        localStorage.removeItem(key);
                    }
                } catch (e) {
                    // Invalid JSON, remove it
                    localStorage.removeItem(key);
                }
            }
        }
    }
};

// --- DEEPL TRANSLATION FUNCTION (WITH FALLBACK) ---
window.handleTranslate = async function(id, encodedText) {
    const box = document.getElementById(`trans-${id}`);
    const toggleBtn = box.previousElementSibling;
    
    // Toggle visibility
    if(box.style.display === 'block') { 
        box.style.display = 'none'; 
        return; 
    }
    
    // Show loading state
    box.innerHTML = '<div style="text-align:center; padding:20px;"><span class="loading"></span> Translating...</div>';
    box.style.display = 'block';
    
    try {
        const originalText = decodeURIComponent(encodedText);
        
        // Map language codes
        let targetLang;
        switch(currentLang) {
            case 'gr': targetLang = 'EL'; break;
            case 'ro': targetLang = 'RO'; break;
            default: targetLang = 'EN-GB'; break;
        }
        
        // If current language is Romanian, show original
        if (currentLang === 'ro') {
            box.textContent = originalText;
            return;
        }
        
        // Check cache first
        const cached = translationCache.get(originalText, targetLang);
        if (cached) {
            box.innerHTML = `<div class="translated-text">${cached.translation}</div>
                            <div class="cache-indicator">✓ From cache</div>`;
            return;
        }
        
        // Try DeepL API first
        let translationResult = null;
        
        if (DEEPL_API_KEY) {
            try {
                translationResult = await translateWithDeepL(originalText, targetLang);
            } catch (deepLError) {
                console.log("DeepL failed, trying MyMemory...", deepLError);
                translationResult = await translateWithMyMemory(originalText, targetLang);
            }
        } else {
            translationResult = await translateWithMyMemory(originalText, targetLang);
        }
        
        // Cache the translation
        if (translationResult) {
            translationCache.set(originalText, targetLang, translationResult);
            box.innerHTML = `<div class="translated-text">${translationResult}</div>`;
        } else {
            box.textContent = "Translation unavailable.";
        }
        
    } catch (error) {
        console.error("Translation error:", error);
        box.textContent = "Error loading translation. Please try again.";
    }
}

// DeepL translation function
async function translateWithDeepL(text, targetLang) {
    // Check if text is too long for single request
    const MAX_DEEPL_LENGTH = 30000; // DeepL limit
    if (text.length > MAX_DEEPL_LENGTH) {
        // Split and translate in chunks
        return await translateLongTextWithDeepL(text, targetLang);
    }
    
    const params = new URLSearchParams();
    params.append('auth_key', DEEPL_API_KEY);
    params.append('text', text);
    params.append('target_lang', targetLang);
    params.append('source_lang', 'RO');
    
    const response = await fetch(DEEPL_API_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: params
    });
    
    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`DeepL API error ${response.status}: ${errorText}`);
    }
    
    const data = await response.json();
    
    if (data.translations && data.translations.length > 0) {
        return data.translations[0].text;
    }
    
    throw new Error('No translation returned from DeepL');
}

// Split long texts for DeepL
async function translateLongTextWithDeepL(text, targetLang) {
    const chunks = splitTextIntoChunks(text, 20000); // Split into 20K char chunks
    
    const translatedChunks = [];
    for (let i = 0; i < chunks.length; i++) {
        try {
            const translatedChunk = await translateWithDeepL(chunks[i], targetLang);
            translatedChunks.push(translatedChunk);
        } catch (error) {
            console.error(`Error translating chunk ${i}:`, error);
            translatedChunks.push(chunks[i]); // Fallback to original
        }
    }
    
    return translatedChunks.join(' ');
}

// MyMemory fallback translation
async function translateWithMyMemory(text, targetLang) {
    // Map language codes for MyMemory
    let myMemoryLang;
    switch(targetLang) {
        case 'EL': myMemoryLang = 'el'; break; // Greek
        default: myMemoryLang = 'en'; break; // English
    }
    
    // Split text if too long for MyMemory
    if (text.length > 450) {
        const chunks = splitTextIntoChunks(text, 450);
        const translatedChunks = [];
        
        for (let i = 0; i < chunks.length; i++) {
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(chunks[i])}&langpair=ro|${myMemoryLang}`);
                const data = await res.json();
                if (data.responseData.translatedText) {
                    translatedChunks.push(data.responseData.translatedText);
                } else {
                    translatedChunks.push(chunks[i]);
                }
            } catch (error) {
                translatedChunks.push(chunks[i]);
            }
        }
        
        return translatedChunks.join(' ');
    } else {
        // Single request for short text
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=ro|${myMemoryLang}`);
        const data = await res.json();
        return data.responseData?.translatedText || text;
    }
}

// Helper function to split text into chunks
function splitTextIntoChunks(text, maxLength) {
    const chunks = [];
    let currentChunk = '';
    
    const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
    
    for (const sentence of sentences) {
        if ((currentChunk + sentence).length <= maxLength) {
            currentChunk += sentence;
        } else {
            if (currentChunk) {
                chunks.push(currentChunk);
            }
            if (sentence.length > maxLength) {
                const words = sentence.split(' ');
                currentChunk = '';
                for (const word of words) {
                    if ((currentChunk + ' ' + word).length <= maxLength) {
                        currentChunk += (currentChunk ? ' ' : '') + word;
                    } else {
                        if (currentChunk) {
                            chunks.push(currentChunk);
                        }
                        currentChunk = word;
                    }
                }
            } else {
                currentChunk = sentence;
            }
        }
    }
    
    if (currentChunk) {
        chunks.push(currentChunk);
    }
    
    return chunks;
}

// --- FIREBASE POST LOGIC ---
window.submitPost = async function() {
    const val = document.getElementById('postInput').value;
    if(!val.trim()) return;

    const statusEl = document.getElementById('post-status');
    statusEl.innerHTML = '<span class="loading"></span> Saving...';

    try {
        if (editingPostId) {
            await updateDoc(doc(db, "posts", editingPostId), {
                text: val,
                date: new Date().toLocaleString(),
                timestamp: Date.now() 
            });
            editingPostId = null;
            document.getElementById('post-button').textContent = translations[currentLang]['post-button'];
        } else {
            await addDoc(collection(db, "posts"), {
                text: val,
                date: new Date().toLocaleString(),
                timestamp: Date.now() 
            });
        }
        
        document.getElementById('postInput').value = '';
        await renderFeed();
        
        statusEl.textContent = '✓ Saved';
        setTimeout(() => {
            statusEl.textContent = '';
        }, 2000);
    } catch (e) {
        console.error("Error: ", e);
        statusEl.textContent = '✗ Error saving';
        setTimeout(() => {
            statusEl.textContent = '';
        }, 2000);
    }
}

window.renderFeed = async function() {
    const feed = document.getElementById('feed');
    feed.innerHTML = '<p style="color:#888; padding:20px; text-align:center;">Loading thoughts...</p>';
    
    try {
        const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
        const querySnapshot = await getDocs(q);
        
        feed.innerHTML = '';
        
        if (querySnapshot.empty) {
            feed.innerHTML = `<div class="feed-item" style="text-align: center; color: #666; font-style: italic;">
                No thoughts shared yet. Check back soon for updates from the author.
            </div>`;
            return;
        }
        
        const btnDisplay = currentLang === 'ro' ? 'none' : 'inline-block';
        const translateText = translations[currentLang]['translate-to'];

        querySnapshot.forEach((docSnap) => {
            const p = docSnap.data();
            const id = docSnap.id;
            const div = document.createElement('div');
            div.className = 'feed-item';
            div.innerHTML = `
                <span class="user-label">Sandu Croitoru</span>
                <span class="timestamp">${p.date}</span>
                <div class="post-content" id="txt-${id}">${p.text}</div>
                <button class="translate-toggle" style="display:${btnDisplay}" onclick="handleTranslate('${id}', '${encodeURIComponent(p.text)}')">${translateText}</button>
                <div class="translated-content" id="trans-${id}"></div>
                <div class="admin-buttons" id="admin-buttons-${id}" style="display:${adminMode ? 'block' : 'none'}">
                    <button class="delete-btn" onclick="deletePost('${id}')">Delete</button>
                    <button class="edit-btn" onclick="editPost('${id}', '${encodeURIComponent(p.text)}')">Edit</button>
                </div>
            `;
            feed.appendChild(div);
        });
    } catch (e) {
        console.error("Error loading feed: ", e);
        feed.innerHTML = '<p style="color:#ff4444; padding:20px; text-align:center;">Error loading thoughts. Make sure you enabled Test Mode in Firestore Database.</p>';
    }
}

window.deletePost = async function(id) {
    try {
        await deleteDoc(doc(db, "posts", id));
        await renderFeed();
    } catch (e) {
        console.error("Error deleting post: ", e);
    }
}

window.editPost = function(id, encodedText) {
    const text = decodeURIComponent(encodedText);
    document.getElementById('postInput').value = text;
    editingPostId = id;
    document.getElementById('post-button').textContent = 'Update';
    document.getElementById('postInput').focus();
}

// --- ADMIN LOGIC ---
window.handleGhostClick = function() {
    if(adminMode) { 
        adminMode = false; 
        document.getElementById('admin-editor-zone').style.display='none'; 
        renderFeed();
    } else { 
        document.getElementById('login-modal').style.display='flex'; 
    }
}

window.attemptLogin = function() {
    const u = document.getElementById('login-username').value;
    const p = document.getElementById('login-password').value;
    
    if(u === "admin" && p === "12345") {
        adminMode = true;
        document.getElementById('admin-editor-zone').style.display='block';
        closeLogin(); 
        renderFeed();
    } else { 
        closeLogin();
    }
}

window.closeLogin = function() { 
    document.getElementById('login-modal').style.display='none'; 
    document.getElementById('login-username').value = '';
    document.getElementById('login-password').value = '';
}

// --- INITIAL LOAD ---
window.addEventListener('DOMContentLoaded', () => {
    startSlideshow();
    applyLang(currentLang);
    renderFeed();
    translationCache.clearOld(); // Clear old cache entries on load
});

// Make functions available globally
window.cycleLanguage = cycleLanguage;
window.showTab = showTab;
window.toggleCover = toggleCover;
</script>
</body>
</html>
